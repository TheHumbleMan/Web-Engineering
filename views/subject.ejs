<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="csrf-token" content="<%= csrfToken %>">
    <title><%= subject.name %></title>
    <link rel="icon" type="image/png" href="/favicon/study_icon.png">
    <link rel="stylesheet" href="/assets/style.css">
    <script defer src="/assets/theme.js"></script>
    <script defer src="/assets/pomodoro.js"></script>
    <script src="/assets/singlesubject.js" defer></script>
</head>
<body>
<header>
    <nav>
        <a href="/grades">Notenübersicht</a>
        <a href="/todo">Lernplan</a>
        <a href="subjects">Zurück zur Übersicht </a>
        <a href="/auth/login">Abmelden</a>

        <label class="theme-toggle">
            <input type="checkbox" id="toggle">
            <span class="slider round">
                <div class="background"></div>
                <div class="star"></div>
                <div class="star"></div>
            </span>
        </label>

    </nav>
</header>
<main>
    <div class="top-banner">
        <h1 id="name"><%= subject.name %></h1>
        <% if (typeof average !== 'undefined' && average !== null) { %>
            <div class="subject-average">Durchschnittsnote: <strong><%= average.toFixed(2) %></strong></div>
        <% } else { %>
            <div class="subject-average muted">Keine Noten vorhanden</div>
        <% } %>

        <button id="saveSubjectBtn">Speichern</button>
        <!-- Lösch-Formular -->
        <form
            action="/subjects/delete"
            method="POST"
            onsubmit="return confirm('Willst du dieses Fach wirklich löschen?');">

            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="id" value="<%= subject.id %>">
            <button type="submit" class="delete-btn">Fach löschen</button>
        </form>
    </div>

    <div class="content">

        <!--Linker Teil für die Notizen und co-->
        <div class="noteblock">
            <div class="subject" id="note-container">
                <h2>Notizen</h2>
                <textarea placeholder="Notizen..." id="note-textarea"><%= subject.note %></textarea>
            </div>

            <!-- Neues Notenformular für dieses Fach -->
            <div class="subject" style="margin-top:12px;padding:12px;">
                <h2>Neue Note hinzufügen</h2>
                <form id="create-grade-form">
                    <input type="hidden" id="grade-subject" name="subject" value="<%= subject.name %>">
                    <div>
                        <label>Titel:<br><input type="text" id="grade-title" name="title" required></label>
                    </div>
                    <div>
                        <label>Datum:<br><input type="date" id="grade-date" name="date" value="<%= new Date().toISOString().slice(0,10) %>"></label>
                    </div>
                    <div>
                        <label>Note:<br><input type="number" step="0.1" min="1" max="6" id="grade-value" name="grade" required></label>
                    </div>
                    <div style="margin-top:8px;">
                        <button type="submit">Neue Note</button>
                    </div>
                </form>
            </div>
        </div>

        <!--Rechter Teil für Prüfungsdatum, Timer und Todos-->
        <div class="sidebar">

            <div id="pruefungs-container" class="subject">
                <div class="line">
                    <h2 class="left">Prüfungsdatum:</h2>
                    <input class="right lineElement"
                        type="date"
                        id="examDate"
                        value="<%=subject.examDate || ''%>"
                        placeholder="-----">
                </div>
                <div class="line">
                    <h2 class="left">Note:</h2>
                    <input class="right lineElement"
                        id="grade"
                        value="<%=subject.grade || ''%>"
                        placeholder="-----">
                </div>
            </div>
            
            <div id="pomodoro-container" class="subject">
                <h2>Pomodoro:</h2>
                <div class="pomodoro">
                    <div class="time" id="pomo-time">25:00</div>
                    <div class="controls">
                        <button id="start">Start</button>
                        <button id="pause">Pause</button>
                        <button id="reset">Reset</button>
                    </div>
                </div>
            </div>

            <div id="todoPopup">
                <label>
                    Aufgabe:
                    <input type="text" id="todoName">
                </label><br><br>
                <label>
                    Priorität:
                    <select id="todoPriority">
                    <option value="niedrig">Niedrig</option>
                    <option value="mittel">Mittel</option>
                    <option value="hoch">Hoch</option>
                    </select>
                </label><br><br>
                <label>
                    Fälligkeitsdatum:
                    <input type="datetime-local" id="todoDueDate">
                </label><br><br>
                <div class="line">
                    <button onclick="submitTodo()">Hinzufügen</button>
                    <button onclick="closePopup()">Abbrechen</button>
                </div>
            </div>

            <div id="todos-container" class="subject">
                <div id="todo-headline">
                    <h2>Todos:</h2>
                    <button id="addTodo">Neues Todo</button>
                </div>
                <% subject.todos.forEach(todo => {
                    let color = "black";

                    if (todo.prio === "niedrig") color = "green";
                    if (todo.prio === "mittel") color = "orange";
                    if (todo.prio === "hoch") color = "red";
                %>

                    <div class="singletodo">
                        <input id="checkbox-<%= todo.id %>" type="checkbox"<%= todo.done === "true" ? "checked" : "" %>>
                        <div class="todo-text prio-<%= todo.prio %>"
                            data-id="<%= todo.id %>"
                            data-done="<%= todo.done %>"
                            data-prio="<%= todo.prio %>"
                            data-dueDate="<%= todo.dueDate %>">
                            
                            <%= todo.text %>
                        </div>

                        <div class="dueDate">
                            Fällig: <%= new Date(todo.dueDate).toLocaleString("de-DE",{dateStyle:"medium", timeStyle:"short"}); %>
                        </div>
                    </div>

                <% }) %>
            </div>
        </div>
    </div>
</main>


<footer>
    <p>© 2026 Lernhilfe - Studienprojekt der DHBW Ravensburg</p>
    <a href="/impressum">Impressum</a>
    <a href="/datenschutz">Datenschutzerklärung</a>
</footer>
</body>
</html>